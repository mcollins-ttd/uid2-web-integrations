<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>UID2 Publisher Standard Integration Example</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/app.css" />
    <link rel="shortcut icon" href="/images/favicon.png" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/js/prebid8.17.0.js"></script>
    <script src="{{ UID2_JS_SDK_URL }}"></script>
    <script>
      const clientSideConfig = {
        subscriptionId: "{{ SUBSCRIPTION_ID }}",
        serverPublicKey: "{{ SERVER_PUBLIC_KEY }}",
      };

      // Example of a base-64 encoded SHA-256 hash of an email address.
      const emailHash = "tMmiiTI7IaAcPpQPFQ65uMVCWH8av9jw4cwf/F5HVRQ=";

      // Example function to pass UID2 advertising token into Prebid.js
      function mergePbjsConfig(advertisingToken) {
        window.pbjs = window.pbjs || {};
        window.pbjs.que = window.pbjs.que || [];
        window.pbjs.que.push(function () {
          pbjs.mergeConfig({
            userSync: {
              userIds: [
                {
                  name: "uid2",
                  value: {
                    uid2: {
                      id: advertisingToken,
                    },
                  },
                },
              ],
            },
          });
          pbjs.refreshUserIds({ submoduleNames: ["uid2"] });
        });
      }

      // When the UID2 SDK is executed, it will look for these callbacks and invoke them.
      window.__uid2 = window.__uid2 || {};
      window.__uid2.callbacks = window.__uid2.callbacks || [];
      window.__uid2.callbacks.push(async (eventType, payload) => {
        console.log("eventType", eventType, "payload", payload);

        switch (eventType) {
          case "SdkLoaded":
            // The SdkLoaded event occurs just once.
            __uid2.init({
              // URL depends on whether you are targeting the integration
              // environment, or the production environment.
              baseUrl: "{{ UID2_BASE_URL }}",
            });
            break;

          case "InitCompleted":
            // The InitCompleted event occurs just once.
            //
            // If there was a valid UID2 token in the cookie, it will be in payload.identity.
            if (payload.identity) {
              // Pass the UID2 Advertising Token to Prebid.js.
              //
              // payload will look like this:
              // {
              //   "identity": {
              //     "advertising_token": "A4A...MqA",
              //     "refresh_token": "A3A...pdg==",
              //     "identity_expires": 1692257038260,
              //     "refresh_expires": 1692339838260,
              //     "refresh_from": 1692254338260
              //     "refresh_response_key": "z0v...zL0="
              //   }
              // }
              mergePbjsConfig(payload.identity.advertising_token);
            } else {
              // Call setIdentityFromEmailHash to generate a new UID2 token from
              // the email hash.
              // Add any retry logic around this call as required.
              await __uid2.setIdentityFromEmailHash(
                emailHash,
                clientSideConfig
              );
            }
            break;

          case "IdentityUpdated":
            // The IdentityUpdated event will happen when:
            //
            // - A UID2 token was generated from setIdentityFromEmailHash, or
            // - The UID2 token was refreshed.
            //
            // Pass the UID2 Advertising Token to Prebid.js.
            // See comment above for an example of how payload will look.
            mergePbjsConfig(payload.identity.advertising_token);
            break;
        }
      });
    </script>
  </head>
  <body>
    <h1>UID2 SDK Integration Example</h1>
    <!-- TODO: Add introductory text here. -->
    <table id="uid2_state">
      <tr>
        <td class="label">Ready for Targeted Advertising:</td>
        <td class="value"><pre id="targeted_advertising_ready"></pre></td>
      </tr>
      <tr>
        <td class="label">UID2 Advertising Token:</td>
        <td class="value"><pre id="advertising_token"></pre></td>
      </tr>
      <tr>
        <td class="label">Is UID2 Login Required?</td>
        <td class="value"><pre id="login_required"></pre></td>
      </tr>
      <tr>
        <td class="label">UID2 Identity Updated Counter:</td>
        <td class="value"><pre id="update_counter"></pre></td>
      </tr>
      <tr>
        <td class="label">UID2 Identity Callback State:</td>
        <td class="value"><pre id="identity_state"></pre></td>
      </tr>
    </table>
    <div id="login_form" style="display: none" class="form">
      <div class="email_prompt">
        <input
          type="text"
          id="email"
          name="email"
          placeholder="Enter an email address"
          style="border-style: none"
          value="test@example.com"
        />
      </div>
      <div>
        <button type="button" class="button" id="login">Log In</button>>
      </div>
    </div>
    <div id="logout_form" style="display: none" class="form">
      <form>
        <button type="button" class="button" id="logout">Log Out</button>
      </form>
    </div>
  </body>
</html>
